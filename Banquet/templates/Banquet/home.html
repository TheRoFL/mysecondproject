{% extends 'index.html' %}

<!-- prettier-ignore -->
{% block content %} {% load static %}
<h1>Формирование банкета</h1>
<head>
  <script>
    var username_id_added = "{{user.id}}";
    var current_client_id_added = "{{current_client.id}}";
    var current_client_name = "{{current_client.type}}";
    localStorage.setItem("username_id", username_id_added);
    localStorage.setItem("current_client_id", current_client_id_added);
    localStorage.setItem("dishFilter", current_client_id_added);
    localStorage.setItem("current_client_name", current_client_name);
    var username_id = localStorage.getItem("username_id");
    var current_client_id = localStorage.getItem("current_client_id");
  </script>
  <link rel="stylesheet" href="/static/styles/menu-grid.css" />
  <link rel="stylesheet" href="/static/styles/banquet.css" />
</head>
<body>
  <div class="body">
    <form id="clientForm" style="margin-left: 10px">
      <label for="clientName">Название клиента:</label>
      <input type="text" id="clientName" required />

      <label for="clientCount">Количество клиентов:</label>
      <input type="number" id="clientCount" required />
      <br />

      <button type="submit">Сохранить</button>
      <button type="button" id="cancelFormBtn">Отменить</button>
    </form>
    <div class="vseClients">
      <!-- prettier-ignore -->
      {% if banquet.clients.all %} 
      {% for client in banquet.clients.all %}
      <div class="my_client formaClienta" data-id="{{client.id}}">
        <div class="formaClienta_header">
          <input
            class="name-input"
            data-id="{{client.id}}"
            value="{{ client.type }}"
          />
          <p
            style="
              font-size: 10px;
              display: inline;
              color: #fff;
              margin-bottom: 12px;
            "
          >
            x
          </p>
          <input
            class="quantity-input"
            data-id="{{client.id}}"
            value="{{ client.quantity }}"
          />

          <button class="delete-client-btn">
            <img
              data-id="{{client.id}}"
              class="musorka"
              src="/static/images/Мусорка.png"
              alt="delete"
            />
          </button>
        </div>

        <button class="menu-client-btn" data-id="{{client.id}}">
          Выбрать для редактирования
        </button>
      </div>

      {% endfor %} {% endif %}
      <button id="showFormBtn" class="formaClienta">+</button>
    </div>

    {% if current_client %}
    <h1>
      Режим редактирования меню "<span
        class="client-name-3"
        data-id="{{client.id}}"
        >{{current_client.type}}</span
      >"
    </h1>
    {% else %}
    <h1>Выберите меню для редактирования</h1>
    {% endif %}
    <style>
      .dish-filter {
        text-decoration: none;
      }

      .active {
        text-decoration: underline;
      }
    </style>
    <button
      class="dish-filter {% if dish_type == 'samples' %}active{% endif %}"
      data-filter="samples"
      id="requestButton"
    >
      Готовые меню
    </button>
    <button
      class="dish-filter {% if dish_type == 'samples' %}active{% endif %}"
      data-filter="all"
      id="requestButton"
    >
      Все блюда
    </button>
    <button
      class="dish-filter {% if dish_type == 'salads' %}active{% endif %}"
      data-filter="salads"
      id="requestButton"
    >
      Салаты
    </button>
    <button
      class="dish-filter {% if dish_type == 'hot_dishes' %}active{% endif %}"
      data-filter="hot_dishes"
      id="requestButton"
    >
      Горячие блюда
    </button>
    <button
      class="dish-filter {% if dish_type == 'drinks' %}active{% endif %}"
      data-filter="drinks"
      id="requestButton"
    >
      Напитки
    </button>
    <button
      class="dish-filter {% if dish_type == 'desserts' %}active{% endif %}"
      data-filter="desserts"
      id="requestButton"
    >
      Десерты
    </button>
    <a
      class="dish-filter {% if dish_type == 'samples' %}active{% endif %}"
      href="/banquet/?dish-filter=samples&editting-clientId={{clientId}}"
      >Готовые меню</a
    >
    {% if dish_type != 'samples' %}
    <div class="grid-container">
      {% for current_dish in current_dishes %}
      <div class="grid-item">
        <div
          class="dishes"
          data-name="{{current_dish.create_tittle}}"
          data-tittle="{{current_dish.name}}"
          data-weight="{{current_dish.weight}}"
          data-price="{{current_dish.price}}"
          data-sostav="{{current_dish.ingredients}}"
          data-type="{{current_dish.type}}"
        >
          <img
            src="http://localhost:8000/media/menu_images/{{current_dish.type}}/{{current_dish.name}}.png"
          />
          <h3>
            {{current_dish.tittle}} / {{current_dish.weight}} гр. /
            {{current_dish.price}} руб.
          </h3>
        </div>
        <h2>
          <button
            class="order-button"
            data-id="{{current_dish.id}}"
            data-name="{{current_dish.tittle}}"
          >
            {% if current_client %} Добавить для "<span
              class="client-name-2"
              data-id="{{client.id}}"
              >{{current_client.type}}</span
            >" {%else%} Выберите клиента {% endif %}
          </button>
        </h2>
      </div>

      {% endfor %}
    </div>

    {% else %}
    <!-- prettier-ignore -->
    <div class="grid-container">
      {% for menu_sample in current_dishes %}

      <h1>{{menu_sample}} текст чтобы  </h1>
      <h2>
        <button
          class="order-button"
          data-id="{{menu_sample.id}}"
          data-name="{{menu_sample.type}}"
        >
          {% if current_client %} Добавить для "<span
            class="client-name-2"
            data-id="{{client.id}}"
            >{{current_client.type}}</span
          >" {%else%} Выберите клиента {% endif %}
        </button>
      </h2>
       {% for dish in menu_sample.dishes.all %}
        <div class="grid-item dishes"    
          data-tittle="{{dish.product.create_tittle2}}"
          data-name="{{dish.product.name}}"
          data-weight="{{dish.product.weight}}"
          data-price="{{dish.product.price}}"
          data-sostav="{{dish.product.ingredients}}"
          data-type="{{dish.product.type}}"
        >
          <img
            src="http://localhost:8000/media/menu_images/{{dish.product.type}}/{{dish.product.create_tittle2}}.png"
        />
          <h3>{{dish.product.name}} / {{dish.product.weight}} гр. / {{dish.product.price}} руб.</h3>
        </div>
      {% endfor %}
      <h1>--------------------------------------------------------------------------------</h1>
      
      {% endfor %}
    </div>

    {% endif %}

    <h1>&nbsp</h1>
    <hr style="width: 90%; height: 3px; background: #e74c3c" />
    <h1>&nbsp</h1>
    <style>
      .delete-btn {
        position: absolute;
        /* Укажите здесь нужные значения для top, left, right или bottom */
      }
      .client_dishOrder-element {
        display: inline-block;
      }
    </style>
    <!-- prettier-ignore -->
    <div class="all_clients">
    {% for client in banquet.clients.all %}
    <div class="client-header">
      <div class="client-info">
        <h1 class="client-info-h1" data-id="{{client.id}}">
          Меню для клиента типа "<span
            class="client-name"
            data-id="{{client.id}}"
            >{{client.type}}</span
          >" в количестве
          <span class="client-quantity" data-id="{{client.id}}"
            >{{client.quantity}}</span
          >
          человек
        </h1>
      </div>
      <div
        class="client-container-{{client.id}}"
        id="client-container-{{client.id}}"
      >
        <!-- prettier-ignore -->
        {% if client.menu %}

        <div class="client-menu" data-id="{{client.id}}-{{client.menu.id}}">
          <div class="client-menu-btn">
            <h1 style="display: inline-block">{{client.menu}}</h1>
            <button
              class="delete-menu-btn"
              data-id="{{client.menu.id}}"
              data-clientId="{{client.id}}"
              style="margin-top: 0px"
            >
              Удалить
            </button>
          </div>
          {% for dish in client.menu.dishes.all %}
          <div class="client-menu-dish" data-id="{{dish.id}}">
            <h1 style="margin-left: 25px">
              -{{dish.product.name}} x {{dish.quantity}} шт. =
              {{dish.price_count}}.00 руб.
            </h1>
          </div>
          {% endfor %}
          <h1 style="margin-left: 15px">
            Итого:
            <span class="menu-total" data-id="{{client.menu.id}}"
              >{{client.menu.all_dishes_price}}</span
            >.00 руб. с человека
          </h1>
          <h1>--------------------------------------------------------</h1>
        </div>

        {%endif%}

        <!-- prettier-ignore -->
        {% comment %} {% else %} {% endcomment %}
        {% for client_dishOrder in client.dishes.all %}
        <div>
          <div
            class="client-orders-{{client_dishOrder.id}}"
            id="client-orders-{{client_dishOrder.id}}"
          >
            <h1>
              <div
                class="client_dishOrder-element"
                data-id="{{client_dishOrder.id}}"
              >
                <!-- prettier-ignore -->
                <h2 style="margin-left: 30px">
                {{client_dishOrder.product.name}} x 
                <span
                  class="client_order_quantity"
                  data-id="{{client.id}}"
                  id="{{client_dishOrder.id}}"
                  >{{client_dishOrder.quantity}} 
                </span> шт. =
               
                <span
                  class="client_order_price"
                  data-id="{{client.id}}"
                  id="{{client_dishOrder.id}}"
                  >{{client_dishOrder.price_count}}</span
                >.00 руб.
              </h2>
              </div>
              <button
                class="delete-btn"
                data-id="{{client_dishOrder.id}}"
                data-clientId="{{client.id}}"
              >
                X
              </button>
            </h1>
          </div>
        </div>
        <!-- prettier-ignore -->
        {% endfor %}
      </div>

      <h2
        class="client-total-price"
        style="margin-top: 50px; margin-left: 20px"
      >
        <!-- prettier-ignore -->
        {% if client.menu %} 
        Итого за всех клиентов:
        <span
          class="order-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
        >
          {{client.total_client_price}}</span
        >.00 руб. x
        <span class="client-quantity-2" data-id="{{client.id}}"
          >{{client.quantity}}</span
        >
        человек =
        <span
          class="client-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
          >{{client.menu_and_orders_price_count}}</span
        >.00 руб.
        <!-- prettier-ignore -->
        {%else %} Итого за всех клиентов:
        <span
          class="order-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
        >
          {{client.price_count}}</span
        >.00 руб. x
        <span class="client-quantity-2" data-id="{{client.id}}"
          >{{client.quantity}}</span
        >
        человек =
        <span
          class="client-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
          >{{client.menu_and_orders_price_count}}</span
        >.00 руб. {%endif%}
      </h2>
    </div>

    <h1>&nbsp</h1>

    {% endfor %}
    </div>
    <h1>
      Сумма заказа:
      <span class="banquet-total-price" data-id="{{banquet.id}}"
        >{{banquet.total_price}}.00 руб.
      </span>
      <button><a href="/banquet/ordering/">Оформить заказ</a></button>
    </h1>
  </div>

  <h1>&nbsp</h1>
  <hr style="width: 90%; height: 3px; background: #e74c3c" />
  <h1>&nbsp</h1>

  {% for menu_sample in menu_samples %} {{menu_sample}} {% endfor %}

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/static/js/banquet_changing.js"></script>
  <script src="/static/js/banquet_edit_links.js"></script>

  <button id="requestButton">Запросить данные</button>
  <div id="result"></div>

  <script>
    $("button.dish-filter").on("click", function () {
      var filter = $(this).data("filter"); // Получаем значение data-filter

      var requestParams = {
        "dish-filter": filter, // Используем полученное значение для параметра запроса
      };

      $.ajax({
        url: "http://127.0.0.1:8000/banquet/",
        method: "GET",
        data: requestParams,
        dataType: "json",
        success: function (data, client_name) {
          // Обработка успешного ответа
          $("#result").text(data); // Эта строка остается без изменений
          data = JSON.parse(data);

          $(document).ready(function () {
            $(".grid-container").empty();
            var jsonData = data;

            const grid_container = document.querySelector(".delete-client-btn");
            jsonData.forEach(function (item, index) {
              var gridItem = $("<div>");
              var gridContainer = $("<div>", { class: "grid-item" });
              var dishDiv = $("<div>", {
                class: "dishes",
                "data-name": item.fields.name,
                "data-tittle": item.fields.name,
                "data-weight": item.fields.weight,
                "data-price": item.fields.price,
                "data-sostav": item.fields.ingredients,
                "data-type": item.fields.type,
              });

              var img = $("<img>", {
                src: "http://localhost:8000/media/" + item.fields.image,
              });

              var h3 = $("<h3>").html(
                `${item.fields.name} / ${item.fields.weight} гр. / ${item.fields.price} руб.`
              );

              var clientId = localStorage.getItem("current_client_id");
              var current_client_name = localStorage.getItem(
                "current_client_name"
              );
              if (clientId) {
                var orderButton = $("<button>", {
                  class: "order-button",
                  "data-id": item.pk,
                  "data-name": item.fields.name,
                }).text(`Добавить для "${current_client_name}"`);
              } else {
                var orderButton = $("<button>", {
                  class: "order-button",
                  "data-id": index + 1,
                  "data-name": item.fields.name,
                }).text("Выберите клиента");
              }

              dishDiv.append(img, h3);
              gridItem.append(dishDiv, $("<h2>").append(orderButton));

              gridContainer.append(gridItem);
              $(".grid-container").append(gridContainer);
            });

            const orderButtons = document.querySelectorAll(".order-button");
            var clientId = localStorage.getItem("current_client_id");

            orderButtons.forEach((button) => {
              if (button.innerText === "Выберите клиента") {
                button.disabled = true;
              }
              const dishId = button.dataset.id;
              const dishTittle = button.dataset.name;
              if (clientId != "") {
                button.addEventListener("click", function () {
                  var username_id = localStorage.getItem("username_id");
                  var clientId = localStorage.getItem("current_client_id");
                  const data_to_send = {
                    action: "added_dish",
                    message: `Заказ "${dishTittle}" добавлен`,
                    current_dish_id: dishId,
                    current_user_id: username_id,
                    current_client_id: clientId,
                  };
                  var currentUrl = window.location.href;
                  const urlObject = new URL(currentUrl);
                  dish_filter = urlObject.searchParams.get("dish-filter");
                  var is_menu = false;
                  if (dish_filter == "samples") {
                    is_menu = true;
                  }
                  if (is_menu) {
                    const new_data_to_send = {
                      action: "menu_add",
                      message: `Заказ "${button.dataset.name}" добавлен`,
                      current_menu_id: button.dataset.id,
                      current_user_id: username_id,
                      current_client_id: clientId,
                    };
                    socket.send(JSON.stringify(new_data_to_send));
                  } else {
                    socket.send(JSON.stringify(data_to_send));
                  }
                });
              }
            });
          });
        },
        error: function (xhr, status, error) {
          console.error(error);
        },
      });
    });
  </script>
  <script></script>
</body>
{% endblock content %}
