{% extends 'index.html' %}

<!-- prettier-ignore -->
{% block content %} {% load static %}
<h1>Формирование банкета</h1>
<head>
  <script>
    var username_id_added = "{{user.id}}";
    var current_client_id_added = "{{current_client.id}}";
    localStorage.setItem("username_id", username_id_added);
    localStorage.setItem("current_client_id", current_client_id_added);
    localStorage.setItem("dishFilter", current_client_id_added);
    var username_id = localStorage.getItem("username_id");
    var current_client_id = localStorage.getItem("current_client_id");
  </script>
  <link rel="stylesheet" href="/static/styles/menu-grid.css" />
  <link rel="stylesheet" href="/static/styles/banquet.css" />
</head>
<body>
  <h1 style="margin-left: 10px">Создать клиента</h1>
  <button id="showFormBtn" style="margin-left: 10px">Добавить клиента</button>

  <div>
    <form id="clientForm" style="margin-left: 10px">
      <label for="clientName">Название клиента:</label>
      <input type="text" id="clientName" required />

      <label for="clientCount">Количество клиентов:</label>
      <input type="number" id="clientCount" required />
      <br />

      <button type="submit">Сохранить</button>
      <button type="button" id="cancelFormBtn">Отменить</button>
    </form>
    <h1>&nbsp</h1>
    <hr style="width: 90%; height: 3px; background: #e74c3c" />
    <h1>&nbsp</h1>
    {% if banquet.clients.all %}
    <div class="my_extra_clients">
      {% for client in banquet.clients.all %}
      <div class="my_client" data-id="{{client.id}}">
        <input
          class="name-input"
          data-id="{{client.id}}"
          value="{{ client.type }}"
        />
        в количестве
        <input
          class="quantity-input"
          data-id="{{client.id}}"
          value="{{ client.quantity }}"
        />
        человек
        <button class="delete-client-btn" data-id="{{client.id}}">
          Удалить
        </button>
        <button class="menu-client-btn" data-id="{{client.id}}">
          Выбрать для редактирования
        </button>
      </div>
      {% endfor %}
    </div>
    <h1>&nbsp</h1>
    <hr style="width: 90%; height: 3px; background: #e74c3c" />
    <h1>&nbsp</h1>
    {% endif %}

    <style>
      .menu-client-btn.active {
        background-color: #b71100; /* Здесь можно задать нужный вам стиль для подсветки */
        text-decoration: underline; /* Подчеркиваем текст кнопки */
      }
    </style>

    {% if current_client %}
    <h1>
      Режим редактирования меню "<span
        class="client-name-3"
        data-id="{{client.id}}"
        >{{current_client.type}}</span
      >"
    </h1>
    {% else %}
    <h1>Выберите меню для редактирования</h1>
    {% endif %}
    <style>
      .dish-filter {
        text-decoration: none;
      }

      .active {
        text-decoration: underline;
      }
    </style>
    <a
      class="dish-filter {% if dish_type == 'samples' %}active{% endif %}"
      href="/banquet/?dish-filter=samples&editting-clientId={{clientId}}"
      >Готовые меню</a
    >
    <a
      class="dish-filter {% if not dish_type %}active{% endif %}"
      href="/banquet/?dish-filter=all&editting-clientId={{clientId}}"
      >Все блюда</a
    >
    <a
      class="dish-filter {% if dish_type == 'salads' %}active{% endif %}"
      href="/banquet/?dish-filter=salads&editting-clientId={{clientId}}"
      >Салаты</a
    >
    <a
      class="dish-filter {% if dish_type == 'hot_dishes' %}active{% endif %}"
      data-id="hot_dishes"
      href="/banquet/?dish-filter=hot_dishes&editting-clientId={{clientId}}"
      >Горячие блюда</a
    >
    <a
      class="dish-filter {% if dish_type == 'drinks' %}active{% endif %}"
      href="/banquet/?dish-filter=drinks&editting-clientId={{clientId}}"
      >Напитки</a
    >
    <a
      class="dish-filter {% if dish_type == 'desserts' %}active{% endif %}"
      href="/banquet/?dish-filter=desserts&editting-clientId={{clientId}}"
      >Десерты</a
    >

    <script>
      // Получаем ссылку на клиентов по классу
      const clientLinks = document.querySelectorAll(".dish-filter");

      function getQueryParamValue(url, param) {
        const urlObject = new URL(url);
        return urlObject.searchParams.get(param);
      }
      // Перебираем ссылки на клиентов и назначаем обработчик события на клик
      clientLinks.forEach((link) => {
        link.addEventListener("click", function () {
          const url = window.location.href;

          const currentPosition = window.scrollY;
          sessionStorage.setItem("scrollPosition", currentPosition);
          // Получаем clientid из data-id атрибута кнопки клиента
          let clientId = null;
          const urlObject = new URL(url);
          clientId = urlObject.searchParams.get("editting-clientId");
          this.href += clientId;

          const urlParams = new URLSearchParams(window.location.search);
          const editting_clientId = urlParams.get("editting-clientId");

          const newURL = link.getAttribute("href");
          const dataId = this.dataset.id;
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const savedPosition = sessionStorage.getItem("scrollPosition");

        if (savedPosition) {
          // Прокручиваем страницу к сохраненной позиции
          window.scrollTo(0, savedPosition);

          // Удаляем сохраненную позицию прокрутки из sessionStorage
          sessionStorage.removeItem("scrollPosition");
        }
      });
      // Получаем все кнопки с классом "menu-client-btn"
      const menuButtons = document.querySelectorAll(".menu-client-btn");

      // Добавляем обработчик событий на каждую кнопку
      menuButtons.forEach((button) => {
        // Получаем значение атрибута data-id у каждой кнопки (client.id)
        const clientId = button.getAttribute("data-id");

        // Добавляем обработчик событий на нажатие кнопки
        button.addEventListener("click", () => {
          const currentPosition = window.scrollY;
          sessionStorage.setItem("scrollPosition", currentPosition);
          var currentUrl = window.location.href;

          // Парсируем параметры текущего URL
          const urlObject = new URL(currentUrl);
          dish_filter = urlObject.searchParams.get("dish-filter");

          window.location.href =
            `/banquet/?editting-clientId=${clientId}` +
            "&dish-filter=" +
            dish_filter;
          window.scrollTo(0, scrollTop);
        });

        // Проверяем текущий URL и сравниваем с целевой ссылкой
        const currentUrl = window.location.pathname.replace(/\/$/, ""); // Удаляем последний слеш, если есть
        const targetUrl = `/banquet/?editting-clientId=${clientId}`;

        function getURLParameter(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        }
        const NewclientId = getURLParameter("editting-clientId");

        if (clientId === NewclientId) {
          // Если текущий URL совпадает с целевой ссылкой, подсвечиваем кнопку
          button.classList.add("active");
          button.textContent = "Выбрано для редактирования";
        }
      });
    </script>
    {% if dish_type != 'samples' %}
    <div class="grid-container">
      {% for current_dish in current_dishes %}
      <div class="grid-item">
        <div
          class="dishes"
          data-name="{{current_dish.create_tittle}}"
          data-tittle="{{current_dish.name}}"
          data-weight="{{current_dish.weight}}"
          data-price="{{current_dish.price}}"
          data-sostav="{{current_dish.ingredients}}"
          data-type="{{current_dish.type}}"
        >
          <img
            src="http://localhost:8000/media/menu_images/{{current_dish.type}}/{{current_dish.name}}.png"
          />
          <h3>
            {{current_dish.tittle}} / {{current_dish.weight}} гр. /
            {{current_dish.price}} руб.
          </h3>
        </div>
        <h2>
          <button
            class="order-button"
            data-id="{{current_dish.id}}"
            data-name="{{current_dish.tittle}}"
          >
            {% if current_client %} Добавить для "<span
              class="client-name-2"
              data-id="{{client.id}}"
              >{{current_client.type}}</span
            >" {%else%} Выберите клиента {% endif %}
          </button>
        </h2>
      </div>

      {% endfor %}
    </div>

    {% else %}
    <!-- prettier-ignore -->
    <div class="grid-container">
      {% for menu_sample in current_dishes %}

      <h1>{{menu_sample}} текст чтобы  </h1>
      <h2>
        <button
          class="order-button"
          data-id="{{menu_sample.id}}"
          data-name="{{menu_sample.type}}"
        >
          {% if current_client %} Добавить для "<span
            class="client-name-2"
            data-id="{{client.id}}"
            >{{current_client.type}}</span
          >" {%else%} Выберите клиента {% endif %}
        </button>
      </h2>
       {% for dish in menu_sample.dishes.all %}
        <div class="grid-item dishes"    
          data-tittle="{{dish.product.create_tittle2}}"
          data-name="{{dish.product.name}}"
          data-weight="{{dish.product.weight}}"
          data-price="{{dish.product.price}}"
          data-sostav="{{dish.product.ingredients}}"
          data-type="{{dish.product.type}}"
        >
          <img
            src="http://localhost:8000/media/menu_images/{{dish.product.type}}/{{dish.product.create_tittle2}}.png"
        />
          <h3>{{dish.product.name}} / {{dish.product.weight}} гр. / {{dish.product.price}} руб.</h3>
        </div>
      {% endfor %}
      <h1>--------------------------------------------------------------------------------</h1>
      
      {% endfor %}
    </div>

    {% endif %}

    <h1>&nbsp</h1>
    <hr style="width: 90%; height: 3px; background: #e74c3c" />
    <h1>&nbsp</h1>
    <style>
      .delete-btn {
        position: absolute;
        /* Укажите здесь нужные значения для top, left, right или bottom */
      }
      .client_dishOrder-element {
        display: inline-block;
      }
      .name-input {
        width: 150px; /* начальная ширина окна */
        height: auto; /* автоматическая высота в зависимости от содержимого */
        min-height: 30px; /* минимальная высота окна */
        border: 1px solid #ccc;
        padding: 5px;
        font-size: 16px;
        resize: vertical; /* разрешить изменение размера по вертикали */
      }
    </style>
    <!-- prettier-ignore -->
    {% for client in banquet.clients.all %}
    <div class="client-header">
      <div class="client-info">
        <h1 class="client-info-h1" data-id="{{client.id}}">
          Меню для клиента типа "<span
            class="client-name"
            data-id="{{client.id}}"
            >{{client.type}}</span
          >" в количестве
          <span class="client-quantity" data-id="{{client.id}}"
            >{{client.quantity}}</span
          >
          человек
        </h1>
      </div>
      <div
        class="client-container-{{client.id}}"
        id="client-container-{{client.id}}"
      >
        <!-- prettier-ignore -->
        {% if client.menu %}

        <div class="client-menu" data-id="{{client.id}}-{{client.menu.id}}">
          <div class="client-menu-btn">
            <h1 style="display: inline-block">{{client.menu}}</h1>
            <button
              class="delete-menu-btn"
              data-id="{{client.menu.id}}"
              data-clientId="{{client.id}}"
              style="margin-top: 0px"
            >
              Удалить
            </button>
          </div>
          {% for dish in client.menu.dishes.all %}
          <div class="client-menu-dish" data-id="{{dish.id}}">
            <h1 style="margin-left: 25px">
              -{{dish.product.name}} x {{dish.quantity}} шт. =
              {{dish.price_count}}.00 руб.
            </h1>
          </div>
          {% endfor %}
          <h1 style="margin-left: 15px">
            Итого:
            <span class="menu-total" data-id="{{client.menu.id}}"
              >{{client.menu.all_dishes_price}}</span
            >.00 руб. с человека
          </h1>
          <h1>--------------------------------------------------------</h1>
        </div>

        {%endif%}

        <!-- prettier-ignore -->
        {% comment %} {% else %} {% endcomment %}
        {% for client_dishOrder in client.dishes.all %}
        <div>
          <div
            class="client-orders-{{client_dishOrder.id}}"
            id="client-orders-{{client_dishOrder.id}}"
          >
            <h1>
              <div
                class="client_dishOrder-element"
                data-id="{{client_dishOrder.id}}"
              >
                <!-- prettier-ignore -->
                <h2 style="margin-left: 30px">
                {{client_dishOrder.product.name}} x 
                <span
                  class="client_order_quantity"
                  data-id="{{client.id}}"
                  id="{{client_dishOrder.id}}"
                  >{{client_dishOrder.quantity}} 
                </span> шт. =
               
                <span
                  class="client_order_price"
                  data-id="{{client.id}}"
                  id="{{client_dishOrder.id}}"
                  >{{client_dishOrder.price_count}}</span
                >.00 руб.
              </h2>
              </div>
              <button
                class="delete-btn"
                data-id="{{client_dishOrder.id}}"
                data-clientId="{{client.id}}"
              >
                X
              </button>
            </h1>
          </div>
        </div>
        <!-- prettier-ignore -->
        {% endfor %}
      </div>

      <h2
        class="client-total-price"
        style="margin-top: 50px; margin-left: 20px"
      >
        <!-- prettier-ignore -->
        {% if client.menu %} 
        Итого за всех клиентов:
        <span
          class="order-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
        >
          (<span class="client-menu-total-price" data-id="{{client.id}}"
            >{{client.menu.all_dishes_price}}</span
          >.00 + {{client.price_count}}.00)</span
        >руб. x
        <span class="client-quantity-2" data-id="{{client.id}}"
          >{{client.quantity}}</span
        >
        человек =
        <span
          class="client-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
          >{{client.menu_and_orders_price_count}}</span
        >.00 руб.
        <!-- prettier-ignore -->
        {%else %} Итого за всех клиентов:
        <span
          class="order-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
        >
          {{client.price_count}}</span
        >.00 руб. x
        <span class="client-quantity-2" data-id="{{client.id}}"
          >{{client.quantity}}</span
        >
        человек =
        <span
          class="client-price-count"
          data-id="{{client.id}}"
          id="{{client.id}}"
          >{{client.menu_and_orders_price_count}}</span
        >.00 руб. {%endif%}
      </h2>
    </div>

    <h1>&nbsp</h1>

    {% endfor %}
    <h1>
      Сумма заказа:
      <span class="banquet-total-price" data-id="{{banquet.id}}"
        >{{banquet.total_price}}.00 руб.
      </span>
      <button><a href="/banquet/ordering/">Оформить заказ</a></button>
    </h1>
  </div>

  <h1>&nbsp</h1>
  <hr style="width: 90%; height: 3px; background: #e74c3c" />
  <h1>&nbsp</h1>

  {% for menu_sample in menu_samples %} {{menu_sample}} {% endfor %}

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/static/js/banquet_changing.js"></script>
</body>
{% endblock content %}
